<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Simulating two overlapping sources &#8212; MARX 6.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/marxwebtheme.css?v=c47e7066" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    
    <script src="../../_static/documentation_options.js?v=b6ed0530"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within MARX 6.0.1 documentation"
          href="../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Including background in a marx simulation" href="../background/background.html" />
    <link rel="prev" title="Simulating an LETG/ACIS-S observation" href="../LETGpow/letgplaw.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../std-parindex.html" title="MARX Parameter Index"
             >MARX Parameters</a> |</li>
        <li class="right" >
          <a href="../background/background.html" title="Including background in a marx simulation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../LETGpow/letgplaw.html" title="Simulating an LETG/ACIS-S observation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MARX 6.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../examples.html" accesskey="U">Examples of MARX in use</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Simulating two overlapping sources</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="simulating-two-overlapping-sources">
<span id="sect-ex-marxcat"></span><h1>Simulating two overlapping sources<a class="headerlink" href="#simulating-two-overlapping-sources" title="Link to this heading">¶</a></h1>
<p>In each run of <strong>marx</strong> the user can choose one and only one source from the list
in <a class="reference internal" href="../../indetail/models.html#sect-sourcemodels"><span class="std std-ref">The spectrum and the spatial shape of the X-ray source</span></a>. Most of these sources are simple geometric shapes
like a point or a disk. The <a class="reference internal" href="../../indetail/models.html#sect-imagesource"><span class="std std-ref">IMAGE Source</span></a> allows the user to specify an intensity image as input to define a complicated morphology on the sky, but the spectrum is the same in every position.</p>
<p>If spectrum <em>and</em> intensity change with position, the user can write his/her own C-code to generate the photons as described in <a class="reference internal" href="../../indetail/models.html#sect-usersource"><span class="std std-ref">USER Source</span></a>. Some of those codes are available for download, see <a class="reference internal" href="../../indetail/models.html#sect-sourcemodels"><span class="std std-ref">The spectrum and the spatial shape of the X-ray source</span></a> for links. The <a class="reference internal" href="../../indetail/models.html#sect-simputsource"><span class="std std-ref">SIMPUT Source</span></a> can also be used for complex input sources, but it requires the user to install the <a class="reference external" href="http://www.sternwarte.uni-erlangen.de/research/sixte/simulation.php">SIMPUT code</a> and write a source specification according to the <a class="reference external" href="http://hea-www.harvard.edu/heasarc/formats/simput-1.1.0.pdf">SIMPUT standard</a>.</p>
<p>However, in most cases it is easier to run <strong>marx</strong> several times and use <a class="reference internal" href="../../Reference/tools.html#marxcat"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marxcat</span></code></a> to combine the simulations.</p>
<p>In this example we want to simulate a binary star, where both components are separated by only a few arcseconds. In the center of the field-of-view that is enough to separate the images of component A and B, but what happens when we insert a grating? Will the dispersed spectra overlap, or can they be separated in the data?</p>
<p>The parameters in the following example are inspired by the observations of the M-dwarf binary EQ Peg (ObsID 8453). An analysis is presented by <a class="reference external" href="http://adsabs.harvard.edu/abs/2008A%26A...491..859L">Liefke et al. (2008)</a>. We will run two <strong>marx</strong> simulations, one for EQ Peg A and one for EQ Peg B. The parameters of the observations (pointing coordinates, roll angle, exposure time, grating) have to be the same for both simulations, but the parameters for the sources (coordinates, count rate, spectrum) are different.</p>
<section id="creating-a-file-with-the-input-spectra">
<h2>Creating a file with the input spectra<a class="headerlink" href="#creating-a-file-with-the-input-spectra" title="Link to this heading">¶</a></h2>
<p>First, we need to generate the input spectra. For this example, we use <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a>, but <a class="reference external" href="http://heasarc.nasa.gov/xanadu/xspec/">XSPEC</a> or <a class="reference external" href="http://space.mit.edu/cxc/isis/">ISIS</a> work very similar.
We need two 2-column text files that tabulate the model flux [photons/sec/keV/cm^2] (second column) as a function of energy [keV] (first column).</p>
<p>Stars are generally well described by an optically thin, collisionally excited plasma. We use a model with only a single temperature component with a different temperature for EQ Peg A and EQ Peg B and slightly non-solar abundances as suggested by <a class="reference external" href="http://adsabs.harvard.edu/abs/2008A%26A...491..859L">Liefke et al. (2008)</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sherpa.astro</span><span class="w"> </span><span class="kn">import</span> <span class="n">ui</span>
<span class="c1"># set source properties</span>
<span class="n">ui</span><span class="o">.</span><span class="n">set_source</span><span class="p">(</span><span class="n">ui</span><span class="o">.</span><span class="n">xsvapec</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">Ne</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="n">a1</span><span class="o">.</span><span class="n">Fe</span> <span class="o">=</span> <span class="mf">0.8</span>

<span class="c1"># get source</span>
<span class="n">my_src</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">get_source</span><span class="p">()</span>

<span class="c1"># set energy grid</span>
<span class="n">bin_width</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">12.</span><span class="p">,</span> <span class="n">bin_width</span><span class="p">)</span>

<span class="c1">### EQ Peg A ###</span>
<span class="c1"># check that out! Download and take number from real data.</span>
<span class="n">a1</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">a1</span><span class="o">.</span><span class="n">kT</span> <span class="o">=</span> <span class="mf">0.95</span>
<span class="c1"># evaluate source on energy grid</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">my_src</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>

<span class="c1"># Sherpa uses the convention that an energy array holds the LOWER end of the bins;</span>
<span class="c1"># Marx that it holds the UPPER end of a bin.</span>
<span class="c1"># Thus, we need to shift energies and flux by one bin.</span>
<span class="c1"># Also, we need to divide the flux by the bin width to obtain the flux density.</span>
<span class="n">ui</span><span class="o">.</span><span class="n">save_arrays</span><span class="p">(</span><span class="s2">&quot;EQPegA_flux.tbl&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">flux</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">bin_width</span><span class="p">],</span>
               <span class="p">[</span><span class="s2">&quot;keV&quot;</span><span class="p">,</span><span class="s2">&quot;photons/s/cm**2/keV&quot;</span><span class="p">],</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">### EQ Peg B ###</span>
<span class="n">a1</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="mf">0.0003</span>
<span class="n">a1</span><span class="o">.</span><span class="n">kT</span> <span class="o">=</span> <span class="mf">0.7</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">my_src</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>

<span class="n">ui</span><span class="o">.</span><span class="n">save_arrays</span><span class="p">(</span><span class="s2">&quot;EQPegB_flux.tbl&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">energies</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">flux</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">bin_width</span><span class="p">],</span>
               <span class="p">[</span><span class="s2">&quot;keV&quot;</span><span class="p">,</span><span class="s2">&quot;photons/s/cm**2/keV&quot;</span><span class="p">],</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>More details about the format of the <strong>marx</strong> input spectrum can be found at <a class="reference internal" href="../../indetail/models.html#parameter-SpectrumFile"><code class="xref std std-par docutils literal notranslate"><span class="pre">SpectrumFile</span></code></a>.</p>
</section>
<section id="running-marx">
<h2>Running <strong>marx</strong><a class="headerlink" href="#running-marx" title="Link to this heading">¶</a></h2>
<p>We run <strong>marx</strong> twice - once for each star.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
<span class="n">obssetup</span> <span class="o">=</span> <span class="s1">&#39;ExposureTime=5e5 TStart=2006.9 GratingType=&quot;HETG&quot; DetectorType=&quot;ACIS-S&quot; &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;DitherModel=&quot;INTERNAL&quot; RA_Nom=352.966 Dec_Nom=19.935 Roll_Nom=290 &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;SourceFlux=-1 SpectrumType=&quot;FILE&quot;&#39;</span>
<span class="n">out_a</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;marx SourceRA=352.96851 SourceDEC=19.937133 &#39;</span> <span class="o">+</span> \
                        <span class="s1">&#39;SpectrumFile=&quot;EQPegA_flux.tbl&quot; OutputDir=EQPegA &#39;</span> <span class="o">+</span> <span class="n">obssetup</span><span class="p">,</span>
                        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">out_b</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;marx SourceRA=352.97011 SourceDEC=19.937225 &#39;</span> <span class="o">+</span> \
                        <span class="s1">&#39;SpectrumFile=&quot;EQPegB_flux.tbl&quot; OutputDir=EQPegB &#39;</span> <span class="o">+</span> <span class="n">obssetup</span><span class="p">,</span>
                        <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../../indetail/models.html#parameter-SourceFlux"><code class="xref std std-par docutils literal notranslate"><span class="pre">SourceFlux</span></code></a> parameter may be used to indicate the integrated flux of
the spectrum. The value of <code class="docutils literal notranslate"><span class="pre">-1</span></code> means that the integrated flux is taken
from the file. The results of the simulation will be written to sub-directories
called <code class="docutils literal notranslate"><span class="pre">EQPegA</span></code> and <code class="docutils literal notranslate"><span class="pre">EQPegB</span></code>, as specified by the <a class="reference internal" href="../../inbrief/simsetup.html#parameter-OutputDir"><code class="xref std std-par docutils literal notranslate"><span class="pre">OutputDir</span></code></a>
parameter. We use <a class="reference internal" href="../../Reference/tools.html#marxcat"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marxcat</span></code></a> to combine both simulations in the
directory <code class="docutils literal notranslate"><span class="pre">EQPeg_both</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;marxcat EQPegA EQPegB EQPeg_both&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>In the simulation we know exactly which photon comes from which star, so we can generate three fits files, one for EQ Peg A only, one for EQ PEg B only, and one that contains both sources, similar to the observed data.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;marx2fits EQPegA EQPegA.fits&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;marx2fits EQPegB EQPegB.fits&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;marx2fits EQPeg_both EQPeg_both.fits&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The fits files can be further processed
with standard <a class="reference external" href="http://cxc.harvard.edu/ciao/">CIAO</a> tools.  As some of these tools require the aspect
history, the <a class="reference internal" href="../../Reference/tools.html#marxasp"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marxasp</span></code></a> program is used to create an aspect
solution file. Since both simulations used the same pointing and dither, we can
use the same asol file for all three fits files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;marxasp MarxDir=&quot;EQPegA&quot; OutputFile=&quot;EQPeg_asol1.fits&quot;&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="analyzing-the-results">
<h2>Analyzing the results<a class="headerlink" href="#analyzing-the-results" title="Link to this heading">¶</a></h2>
<p>It is interesting to look at the event file with a viewer such as
<a class="reference external" href="http://ds9.si.edu/">ds9</a>. The grating spectra of EQ Peg A and EQ Peg B are close to each other on
the detector, and we’ll now test if the spectrum of EQ Peg A contaminates the
spectrum of EQ Peg B.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pycrates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.visualization</span><span class="w"> </span><span class="kn">import</span> <span class="n">PercentileInterval</span><span class="p">,</span> <span class="n">LogStretch</span><span class="p">,</span> <span class="n">ImageNormalize</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;aspect&#39;</span><span class="p">:</span><span class="s1">&#39;equal&#39;</span><span class="p">})</span>
<span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="mi">400</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">bin_size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="nb">range</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">4096</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">bin_size</span> <span class="o">*</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4096</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">bin_size</span> <span class="o">*</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="mi">4400</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">bin_size</span> <span class="o">*</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4400</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">bin_size</span> <span class="o">*</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
<span class="n">evt</span> <span class="o">=</span> <span class="n">pycrates</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s1">&#39;EQPeg_both.fits&#39;</span><span class="p">)</span>
<span class="n">hist</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">evt</span><span class="o">.</span><span class="n">get_column</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                            <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="nb">range</span><span class="p">)</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">hist</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">PercentileInterval</span><span class="p">(</span><span class="mf">99.9</span><span class="p">),</span> <span class="n">stretch</span><span class="o">=</span><span class="n">LogStretch</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">hist</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span>
        <span class="n">extent</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../../_downloads/bb854cc09c4a8467e61518108fead562/marxcat-6.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/4ad1d9b173320bf394430738249232a4/marxcat-6.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/e5fb457d7bec17cb3778fd7695a227e7/marxcat-6.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default" id="id2">
<img alt="Two spectra on a detector very close to each other." class="plot-directive" src="../../_images/marxcat-6.png" />
<figcaption>
<p><span class="caption-text">Small section of the detector image of the combined simulation</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>The grating spectra of both sources are located fairly close to each
other. On the top right is an MEG arm, the fainter signal of an HEG arm is
seen on the top left. The streak running mostly from left to right with a slight
downward slope is the read-out streak.</p>
<p>We use <a class="reference external" href="http://cxc.harvard.edu/ciao/">CIAO</a> to extract the grating spectrum from <code class="docutils literal notranslate"><span class="pre">EQPegB.fits</span></code> and
<code class="docutils literal notranslate"><span class="pre">EGPeg_both.fits</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">ciao_contrib.runtool</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">rt</span>

<span class="c1"># determined by hand in ds9 to make sure we pick the fainter source</span>
<span class="n">X</span><span class="o">=</span><span class="mf">4068.3</span>
<span class="n">Y</span><span class="o">=</span><span class="mf">4112.7</span>

<span class="c1"># We&#39;ll use the same mask for both extractions, because we want the same region.</span>
<span class="n">rt</span><span class="o">.</span><span class="n">tg_create_mask</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="s2">&quot;EQPegB.fits&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;EQPegB_reg1a.fits&quot;</span><span class="p">,</span>
                  <span class="n">use_user_pars</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">last_source_toread</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span>
                  <span class="n">sA_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sA_zero_x</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">sA_zero_y</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">grating_obs</span><span class="o">=</span><span class="s2">&quot;header_value&quot;</span><span class="p">,</span> <span class="n">width_factor_hetg</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                  <span class="c1"># see https://github.com/cxcsds/ciao-contrib/issues/1016</span>
                  <span class="c1"># on why the following parameters are set to zero</span>
                  <span class="c1"># (which means &quot;default&quot;) here</span>
                  <span class="n">sA_zero_rad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sA_width_heg</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sA_width_meg</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="c1">### Extract EQ Peg B from the EQ PEg B - only simulation ###</span>

<span class="n">rt</span><span class="o">.</span><span class="n">tg_resolve_events</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="s2">&quot;EQPegB.fits&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;EQPegB_evt1a.fits&quot;</span><span class="p">,</span>
                     <span class="n">regionfile</span><span class="o">=</span><span class="s2">&quot;EQPegB_reg1a.fits&quot;</span><span class="p">,</span> <span class="n">acaofffile</span><span class="o">=</span><span class="s2">&quot;EQPeg_asol1.fits&quot;</span><span class="p">,</span>
                     <span class="n">osipfile</span><span class="o">=</span><span class="s2">&quot;CALDB&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">rt</span><span class="o">.</span><span class="n">tgextract</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="s2">&quot;EQPegB_evt1a.fits&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;EQPegB_pha2.fits&quot;</span><span class="p">,</span>
             <span class="n">tg_order_list</span><span class="o">=</span><span class="s2">&quot;-1,+1&quot;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">### Extract EQ Peg B from the combined simulation ###</span>

<span class="n">rt</span><span class="o">.</span><span class="n">tg_resolve_events</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="s2">&quot;EQPeg_both.fits&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;EQPegB_both_evt1a.fits&quot;</span><span class="p">,</span>
                     <span class="n">regionfile</span><span class="o">=</span><span class="s2">&quot;EQPegB_reg1a.fits&quot;</span><span class="p">,</span> <span class="n">acaofffile</span><span class="o">=</span><span class="s2">&quot;EQPeg_asol1.fits&quot;</span><span class="p">,</span>
                     <span class="n">osipfile</span><span class="o">=</span><span class="s2">&quot;CALDB&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">rt</span><span class="o">.</span><span class="n">tgextract</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="s2">&quot;EQPegB_both_evt1a.fits&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;EQPegB_both_pha2.fits&quot;</span><span class="p">,</span>
             <span class="n">tg_order_list</span><span class="o">=</span><span class="s2">&quot;-1,+1&quot;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># make response matrices for the MEG +1 order</span>
<span class="c1"># In practice, one would of course create arf and rmf files for all orders</span>
<span class="c1"># but for this example one is enough (to make it after to run the code).</span>
<span class="c1"># We are extracting the exact same region in both cases above for EXACTLY the same</span>
<span class="c1"># observational parameters (aimpoint, exposure time, ...).</span>
<span class="c1"># Thus the arf and rmf files will be identical, so we have to run this only once.</span>
<span class="n">pharow</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># MEG +1 order</span>
<span class="n">order</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

<span class="n">rt</span><span class="o">.</span><span class="n">mkgrmf</span><span class="p">(</span><span class="n">grating_arm</span><span class="o">=</span><span class="s2">&quot;MEG&quot;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;eqpeg_meg</span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">_rmf.fits&quot;</span><span class="p">,</span>
            <span class="n">srcid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">detsubsys</span><span class="o">=</span><span class="s2">&quot;ACIS-S3&quot;</span><span class="p">,</span> <span class="n">obsfile</span><span class="o">=</span><span class="s2">&quot;EQPegB_pha2.fits&quot;</span><span class="p">,</span>
            <span class="n">regionfile</span><span class="o">=</span><span class="s2">&quot;EQPegB_pha2.fits&quot;</span><span class="p">,</span>
            <span class="n">wvgrid_arf</span><span class="o">=</span><span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="n">wvgrid_chan</span><span class="o">=</span><span class="s2">&quot;compute&quot;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># fullgarf produces a lot of output. Let&#39;s capture that in a variable in case we need it.</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">rt</span><span class="o">.</span><span class="n">fullgarf</span><span class="p">(</span><span class="n">phafile</span><span class="o">=</span><span class="s2">&quot;EQPegB_pha2.fits&quot;</span><span class="p">,</span> <span class="n">pharow</span><span class="o">=</span><span class="n">pharow</span><span class="p">,</span>
                    <span class="n">evtfile</span><span class="o">=</span><span class="s2">&quot;EQPegB.fits&quot;</span><span class="p">,</span> <span class="n">asol</span><span class="o">=</span><span class="s2">&quot;EQPeg_asol1.fits&quot;</span><span class="p">,</span>
                    <span class="n">engrid</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;grid(eqpeg_meg</span><span class="si">{</span><span class="n">order</span><span class="si">}</span><span class="s2">_rmf.fits[cols ENERG_LO,ENERG_HI])&quot;</span><span class="p">,</span>
                    <span class="n">maskfile</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span> <span class="n">dafile</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span> <span class="n">dtffile</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span> <span class="n">badpix</span><span class="o">=</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
                    <span class="n">rootname</span><span class="o">=</span><span class="s2">&quot;eqpeg&quot;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">ardlibqual</span><span class="o">=</span><span class="s2">&quot;;UNIFORM;bpmask=0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that we use <code class="docutils literal notranslate"><span class="pre">ardlibqual=&quot;;UNIFORM;bpmask=0&quot;</span></code> in <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/fullgarf.html">fullgarf</a> because <strong>marx</strong> does not simulate QE maps or bad pixels.
Now, we want to make use of our <strong>marx</strong> simulation to see how much the spectrum
of EQ Peg A contaminates the extracted grating spectrum of EQ Peg B.
We compare the spectra in <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a>. The difference between the two spectra in
some of the lines is caused by photons from EQ Peg A that fall in the
extraction region of EQ Peg B.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ui</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="s1">&#39;EQPegB_both_pha2.fits&#39;</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_arf</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;eqpegMEG_1_garf.fits&#39;</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_rmf</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;eqpeg_meg1_rmf.fits&#39;</span><span class="p">)</span>
<span class="c1"># Load all spectra from pha2file (HEG-1, HEG+1, MEG-1, MEG+1)</span>
<span class="c1"># And label them with is 11, 12, 13, 14</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="s1">&#39;EQPegB_pha2.fits&#39;</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_arf</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;eqpegMEG_1_garf.fits&#39;</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_rmf</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="s1">&#39;eqpeg_meg1_rmf.fits&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">]:</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">set_analysis</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;wave&#39;</span><span class="p">)</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">ignore_id</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">4.</span><span class="p">)</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">ignore_id</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mf">15.</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">ui</span><span class="o">.</span><span class="n">group_width</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">ui</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">yerrorbars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EQ Peg B from combined simulation&#39;</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="n">overplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">yerrorbars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;EQ Peg B from EQ Peg B only simulation&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../../_downloads/f7d0ad897f75c13a751dbd50b6eae0a4/marxcat-8.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/1ccc538a3077f0f229c2757d4292420d/marxcat-8.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/5d059c14d8e16cbb09afc02913855e6e/marxcat-8.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default" id="id4">
<img alt="The spetra differ only at short wavelength." class="plot-directive" src="../../_images/marxcat-8.png" />
<figcaption>
<p><span class="caption-text">Contaminated and clean spectrum extracted for EQ Peg B (MEG order +1).</span><a class="headerlink" href="#id4" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Looking at this figure, we see that both spectra are very similar, but not
identical - that is the contamination by EQ Peg A.</p>
<p><a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/tgextract.html">tgextract</a> uses only the innermost part of the extraction region for the source spectrum and apparently that is
narrow enough to avoid most of the contamination. Still, if we want to measure
or fit lines in the EQ Peg B spectrum we have to be careful.</p>
<p><strong>marx</strong> simulations do not contain any background, but real data does and one
common (although arguably not the best) approach is to subtract a background
spectrum from the data. What would happen if we blindly subtracted
the background from the EQ Peg B spectrum?</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ui</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../../_downloads/0e8598a0f2ccb3e95161789d6f98b58c/marxcat-9.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/a1a661d98e79fa629b7c85aaba1a72eb/marxcat-9.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/4af1d644c340db94ee5dbd789c37d3cf/marxcat-9.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default" id="id6">
<img alt="spectrum with negative bins" class="plot-directive" src="../../_images/marxcat-9.png" />
<figcaption>
<p><span class="caption-text">“Background subtracted” spectrum for EQ Peg B</span><a class="headerlink" href="#id6" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Because the bright spectrum
of EQ Peg A falls in the detector region where the background is measured,
the background is overestimated and causes bins with negative fluxes here.
We end up with a spectrum
with a significant number of negative bins because the much brighter spectrum of EQ
Peg A falls in the region where <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/tgextract.html">tgextract</a> extracts the background,
leading to an overestimate of the background.</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>This example shows how <a class="reference internal" href="../../Reference/tools.html#marxcat"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marxcat</span></code></a> can be used to build up a more complex distribution of sources on the sky from simple components. We can asses how much the sources overlap and compare the simulated spectra of each component and thus estimate the contamination in the real data.</p>
<p>In this example we simulated grating spectra of a binary star, but the same principle works for all cases where sources overlap on the detector, e.g. a cluster of galaxies with a foreground HMXB, binary AGN, or imaging of a dense star forming region.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<form action="../../search.html" method="get">
<input type="text" name="q" placeholder="Search" />
<input type="hidden" name="check_keywords" value="yes" />
<input type="hidden" name="area" value="default" />
</form>
  <h3><a href="../../index.html">Page Content</a></h3>
  <ul>
<li><a class="reference internal" href="#">Simulating two overlapping sources</a><ul>
<li><a class="reference internal" href="#creating-a-file-with-the-input-spectra">Creating a file with the input spectra</a></li>
<li><a class="reference internal" href="#running-marx">Running <strong>marx</strong></a></li>
<li><a class="reference internal" href="#analyzing-the-results">Analyzing the results</a></li>
<li><a class="reference internal" href="#summary">Summary</a></li>
</ul>
</li>
</ul>

  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="../LETGpow/letgplaw.html"
                          title="previous chapter">Simulating an LETG/ACIS-S observation</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../background/background.html"
                          title="next chapter">Including background in a <strong>marx</strong> simulation</a></p>
  </div><hr style="color: #FFF;"></hr>
<a href="http://cxc.harvard.edu/">
    <img src="../../_static/cxcfooterCXCicon.png" 
	 alt="Chandra X-ray Center" class="img-logo"></img>
</a>
<p></p>
<a href="http://space.mit.edu/cxc/">CXC@MIT</a>
<p></p>
<a href="http://space.mit.edu/">
    <img src="../../_static/logo-mit-kavli.png" 
	 alt="MIT Kavli Institute" class="img-logo"></img>
</a>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../std-parindex.html" title="MARX Parameter Index"
             >MARX Parameters</a> |</li>
        <li class="right" >
          <a href="../background/background.html" title="Including background in a marx simulation"
             >next</a> |</li>
        <li class="right" >
          <a href="../LETGpow/letgplaw.html" title="Simulating an LETG/ACIS-S observation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MARX 6.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../examples.html" >Examples of MARX in use</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Simulating two overlapping sources</a></li> 
      </ul>
    </div>
    <div class="footer">
    <a href="mailto:marx-help@space.mit.edu">MARX support: marx-help@space.mit.edu</a>
    <a href="https://accessibility.mit.edu/">Accessibility</a>
        &copy; Copyright 2002-2023, Massachusetts Institute of Technology.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>