<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Simulating a user-defined CCD spectrum with ACIS &#8212; MARX 6.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/marxwebtheme.css?v=8224f6db" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css?v=7f9a90b1" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    
    <script src="../../_static/documentation_options.js?v=b6ed0530"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within MARX 6.0.1 documentation"
          href="../../_static/opensearch.xml"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Simulating a thermal plasma with the HETGS grating" href="../aped/aped.html" />
    <link rel="prev" title="Examples of MARX in use" href="../examples.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../std-parindex.html" title="MARX Parameter Index"
             >MARX Parameters</a> |</li>
        <li class="right" >
          <a href="../aped/aped.html" title="Simulating a thermal plasma with the HETGS grating"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../examples.html" title="Examples of MARX in use"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MARX 6.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../examples.html" accesskey="U">Examples of MARX in use</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Simulating a user-defined CCD spectrum with ACIS</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="simulating-a-user-defined-ccd-spectrum-with-acis">
<span id="sect-ex-acisccd"></span><h1>Simulating a user-defined CCD spectrum with ACIS<a class="headerlink" href="#simulating-a-user-defined-ccd-spectrum-with-acis" title="Link to this heading">¶</a></h1>
<p>The purpose of this example is to show how to use <strong>marx</strong> to simulate an ACIS
observation of a point source with a user-specified spectrum.  For
simplicity, suppose that we wish to simulate a 100 ksec observation of
an on-axis point source whose spectrum is represented by an absorbed powerlaw,
with a spectral index of 1.8, and a column density of <span class="math notranslate nohighlight">\(10^{22}\)</span> atoms/cm^2.
The normalization of the powerlaw will be set to 0.001
photons/keV/cm^2/s at 1 keV.</p>
<section id="creating-the-spectral-file">
<h2>Creating the spectral file<a class="headerlink" href="#creating-the-spectral-file" title="Link to this heading">¶</a></h2>
<p>The first step is to create a 2-column text file that tabulates
the flux [photons/sec/keV/cm^2] (second column) as a
function of energy [keV] (first column).  The easiest way to create
such a file is to make use of a spectral modeling program such as <a class="reference external" href="http://space.mit.edu/cxc/isis/">ISIS</a>,
<a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a> or <a class="reference external" href="http://heasarc.nasa.gov/xanadu/xspec/">XSpec</a>.  The rest of this tutorial is given in the context of
<a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a>.</p>
<p>In <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a> the absorbed powerlaw model is specified using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sherpa.astro</span><span class="w"> </span><span class="kn">import</span> <span class="n">ui</span>

<span class="c1"># set source properties</span>
<span class="n">ui</span><span class="o">.</span><span class="n">set_source</span><span class="p">(</span><span class="n">ui</span><span class="o">.</span><span class="n">xsphabs</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">ui</span><span class="o">.</span><span class="n">xspowerlaw</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">nH</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">p</span><span class="o">.</span><span class="n">PhoIndex</span> <span class="o">=</span> <span class="mf">1.8</span>
<span class="n">p</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="mf">0.001</span>

<span class="n">my_src</span> <span class="o">=</span> <span class="n">ui</span><span class="o">.</span><span class="n">get_source</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">my_src</span><span class="p">))</span>
</pre></div>
</div>
<p>The model parameters listed by <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a> should look like this:</p>
<div class="code highlight-none notranslate"><div class="highlight"><pre><span></span>xsphabs.a * xspowerlaw.p
   Param        Type          Value          Min          Max      Units
   -----        ----          -----          ---          ---      -----
   a.nH         thawed            1            0        1e+06 10^22 atoms / cm^2
   p.PhoIndex   thawed          1.8           -3           10
   p.norm       thawed        0.001            0        1e+24
</pre></div>
</div>
<p>The next step is to convert the model to the
spectrum file that <strong>marx</strong> expects. We can use the commands below (see also the <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a> thread
<a class="reference external" href="http://cxc.harvard.edu/sherpa/threads/marx/">http://cxc.harvard.edu/sherpa/threads/marx/</a> for another example):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="c1"># set energy grid</span>
<span class="n">bin_width</span> <span class="o">=</span> <span class="mf">0.003</span>
<span class="n">energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.03</span><span class="p">,</span> <span class="mf">12.</span><span class="p">,</span> <span class="n">bin_width</span><span class="p">)</span>

<span class="c1"># evaluate source on energy grid with lower and upper bin edges</span>
<span class="n">flux</span> <span class="o">=</span> <span class="n">my_src</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">energies</span> <span class="o">+</span> <span class="n">bin_width</span><span class="p">)</span>

<span class="c1"># MARX input files only have one energy column, and the convention is that</span>
<span class="c1"># this holds the UPPER edge of the bin.</span>
<span class="c1"># Also, we need to divide the flux by the bin width to obtain the flux density.</span>
<span class="n">ui</span><span class="o">.</span><span class="n">save_arrays</span><span class="p">(</span><span class="s2">&quot;plawflux.tbl&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">energies</span> <span class="o">+</span> <span class="n">bin_width</span><span class="p">,</span> <span class="n">flux</span> <span class="o">/</span> <span class="n">bin_width</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;keV&quot;</span><span class="p">,</span><span class="s2">&quot;photons/s/cm**2/keV&quot;</span><span class="p">],</span> <span class="n">ascii</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference external" href="http://space.mit.edu/cxc/isis/">ISIS</a> users can make use of the  <a class="reference internal" href="../../Reference/tools.html#marxflux"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marxflux</span></code></a> script and for <a class="reference external" href="http://heasarc.nasa.gov/xanadu/xspec/">XSpec</a> users,
<strong>marx</strong> is distributed with a script called <a class="reference internal" href="../../Reference/tools.html#xspec2marx"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">xspec2marx</span></code></a> that may be used
to create such a file.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">plawflux.tbl</span></code> file is input to <strong>marx</strong> using the following
<code class="docutils literal notranslate"><span class="pre">marx.par</span></code> parameters:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SpectrumType=FILE
SpectrumFile=plawflux.tbl
SourceFlux=-1
</pre></div>
</div>
<p>The <a class="reference internal" href="../../indetail/models.html#parameter-SpectrumType"><code class="xref std std-par docutils literal notranslate"><span class="pre">SpectrumType</span></code></a> parameter is set to <code class="docutils literal notranslate"><span class="pre">FILE</span></code> to indicate that
<strong>marx</strong> is to read the spectrum from the file specified by the
<a class="reference internal" href="../../indetail/models.html#parameter-SpectrumFile"><code class="xref std std-par docutils literal notranslate"><span class="pre">SpectrumFile</span></code></a> parameter.  The <a class="reference internal" href="../../indetail/models.html#parameter-SourceFlux"><code class="xref std std-par docutils literal notranslate"><span class="pre">SourceFlux</span></code></a> parameter may be
used to indicate the integrated flux of the spectrum.  The value of <code class="docutils literal notranslate"><span class="pre">-1</span></code>
as given above means that the integrated flux is to be taken from the
file.</p>
</section>
<section id="running-marx-for-this-powerlaw-spectrum">
<h2>Running marx for this powerlaw spectrum<a class="headerlink" href="#running-marx-for-this-powerlaw-spectrum" title="Link to this heading">¶</a></h2>
<p>The next step is to run <strong>marx</strong> in the desired configuration.  Some
prefer to use tools such as <a class="reference internal" href="../../Reference/tools.html#pset"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">pset</span></code></a> to update the <code class="docutils literal notranslate"><span class="pre">marx.par</span></code>
file and then run <strong>marx</strong> or to pass the arguments via the command line
in a shell. Here, we will wrap the <strong>marx</strong> call into a Python script. Since
<strong>marx</strong> currently does not have a “nice” Python interface, we pass the exact
string we would use on the command line to the shell using
<a class="reference external" href="https://docs.python.org/3/library/subprocess.html#subprocess.call" title="(in Python v3.14)"><code class="xref py py-func docutils literal notranslate"><span class="pre">subprocess.call()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>

<span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;marx SourceFlux=-1 SpectrumType=&quot;FILE&quot; SpectrumFile=&quot;plawflux.tbl&quot; &#39;</span> <span class="o">+</span> \
<span class="s1">&#39;ExposureTime=100000 TStart=2012.5 &#39;</span> <span class="o">+</span> \
<span class="s1">&#39;OutputDir=plaw GratingType=&quot;NONE&quot; DetectorType=&quot;ACIS-S&quot; &#39;</span> <span class="o">+</span> \
<span class="s1">&#39;DitherModel=&quot;INTERNAL&quot; RA_Nom=30 Dec_Nom=40 Roll_Nom=50 &#39;</span> <span class="o">+</span> \
<span class="s1">&#39;SourceRA=30 SourceDEC=40 &#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This will run the simulation and place the results in a subdirectory
called <code class="docutils literal notranslate"><span class="pre">plaw</span></code>.  The results may be converted to a standard Chandra
level-2 fits file by the <a class="reference internal" href="../../Reference/tools.html#marx2fits"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marx2fits</span></code></a> program:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;marx2fits plaw plaw_evt2.fits&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, one could just paste the string on the command line instead of using
Python to get the same result:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>unix% marx2fits plaw plaw_evt2.fits
</pre></div>
</div>
<p>The resulting fits file <code class="docutils literal notranslate"><span class="pre">plaw_evt2.fits</span></code> may be further processed
with standard <a class="reference external" href="http://cxc.harvard.edu/ciao/">CIAO</a> tools.  As some of these tools require the aspect
history, the <a class="reference internal" href="../../Reference/tools.html#marxasp"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marxasp</span></code></a> program will be used to create an aspect
solution file that matches the simulation (and, of course, this could also
be done on the command line instead):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;marxasp MarxDir=&#39;plaw&#39; OutputFile=&#39;plaw_asol1.fits&#39;&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="creating-ciao-based-arfs-and-rmfs-for-marx-simulations">
<span id="ex-ciao"></span><h2>Creating CIAO-based ARFs and RMFs for MARX Simulations<a class="headerlink" href="#creating-ciao-based-arfs-and-rmfs-for-marx-simulations" title="Link to this heading">¶</a></h2>
<p>Armed with the simulated event file <code class="docutils literal notranslate"><span class="pre">plaw_evt2.fits</span></code> and the aspect
solution file <code class="docutils literal notranslate"><span class="pre">plaw_asol1.fits</span></code>, a PHA file, ARF and RMF may be
made using the standard <a class="reference external" href="http://cxc.harvard.edu/ciao/">CIAO</a> tools. First, extract the PHA data. The <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/asphist.html">asphist</a> CIAO
tool may be used to create an aspect histogram from an aspect solution
file. Again, we are using a <a class="reference external" href="https://cxc.cfa.harvard.edu/ciao/scripting/runtool.html">Python interface to CIAO</a> to run the CIAO tools:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ciao_contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">runtool</span> <span class="k">as</span> <span class="n">rt</span>
<span class="c1"># Extraction region parameters: circle of radius R at (X,Y)</span>
<span class="n">X</span><span class="o">=</span><span class="mf">4096.5</span>
<span class="n">Y</span><span class="o">=</span><span class="mf">4096.5</span>
<span class="n">R</span><span class="o">=</span><span class="mf">20.0</span>

<span class="n">phagrid</span><span class="o">=</span><span class="s2">&quot;pi=1:1024:1&quot;</span>

<span class="n">evtfile</span><span class="o">=</span><span class="s2">&quot;plaw_evt2.fits&quot;</span>
<span class="n">asolfile</span><span class="o">=</span><span class="s2">&quot;plaw_asol1.fits&quot;</span>
<span class="n">phafile</span><span class="o">=</span><span class="s2">&quot;plaw_pha.fits&quot;</span>
<span class="n">rmffile</span><span class="o">=</span><span class="s2">&quot;plaw_rmf.fits&quot;</span>
<span class="n">arffile</span><span class="o">=</span><span class="s2">&quot;plaw_arf.fits&quot;</span>
<span class="n">asphistfile</span><span class="o">=</span><span class="s2">&quot;plaw_asp.fits&quot;</span>

<span class="n">rt</span><span class="o">.</span><span class="n">asphist</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">asolfile</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">asphistfile</span><span class="p">,</span> <span class="n">evtfile</span><span class="o">=</span><span class="n">evtfile</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">rt</span><span class="o">.</span><span class="n">dmextract</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">evtfile</span><span class="si">}</span><span class="s2">[sky=Circle(</span><span class="si">{</span><span class="n">X</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">Y</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="s2">)][bin </span><span class="si">{</span><span class="n">phagrid</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
<span class="n">outfile</span><span class="o">=</span><span class="n">phafile</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>While <strong>marx</strong> strives to accurately model of the Chandra Observatory, there
are some differences that need to be taken into account when
processing <strong>marx</strong> generated data with <a class="reference external" href="http://cxc.harvard.edu/ciao/">CIAO</a>.  As described in <a class="reference internal" href="../../inbrief/caveats.html#caveats"><span class="std std-ref">Current caveats for MARX</span></a>
page, <strong>marx</strong> does not incorporate the
non-uniformity maps for the ACIS detector, nor does it employ the
spatially varying CTI-corrected pha redistribution matrices (RMFs).
As such there will be systematic differences between the <strong>marx</strong> ACIS
effective area and that of the <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkarf.html">mkarf</a> CIAO tool when run in its
default mode.  Similarly, the mapping from energy to pha by <strong>marx</strong> will
be different from that predicted by <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkacisrmf.html">mkacisrmf</a>.</p>
<section id="creating-an-arf-to-match-a-marx-simulation">
<h3>Creating an ARF to match a marx simulation<a class="headerlink" href="#creating-an-arf-to-match-a-marx-simulation" title="Link to this heading">¶</a></h3>
<p>As mentioned above, <strong>marx</strong> does not implement the ACIS QE uniformity
maps.  The following commands show how to set the <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkarf.html">mkarf</a> parameters
to produce an ARF that is consistent with the <strong>marx</strong> effective area (this
continues the Python script from the last paragraph):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select a CCD.</span>
<span class="n">ccdid</span><span class="o">=</span><span class="mi">7</span>

<span class="n">detname</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;ACIS-</span><span class="si">{</span><span class="n">ccdid</span><span class="si">}</span><span class="s2">;UNIFORM;bpmask=0&quot;</span>
<span class="c1"># For ACIS-I, use engrid=&quot;0.3:11.0:0.003&quot;. This reflects a limitation of mkrmf.</span>
<span class="n">engrid</span><span class="o">=</span><span class="s2">&quot;0.3:12.0:0.003&quot;</span>

<span class="n">rt</span><span class="o">.</span><span class="n">mkarf</span><span class="o">.</span><span class="n">punlearn</span><span class="p">()</span>
<span class="n">rt</span><span class="o">.</span><span class="n">mkarf</span><span class="p">(</span><span class="n">detsubsys</span><span class="o">=</span><span class="n">detname</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">arffile</span><span class="p">,</span> <span class="n">obsfile</span><span class="o">=</span><span class="n">evtfile</span><span class="p">,</span> <span class="n">engrid</span><span class="o">=</span><span class="n">engrid</span><span class="p">,</span>
         <span class="n">asphistfile</span><span class="o">=</span><span class="n">asphistfile</span><span class="p">,</span> <span class="n">sourcepixelx</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">sourcepixely</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice the settings <code class="docutils literal notranslate"><span class="pre">detsubsys=&quot;ACIS-7;uniform;bpmask=0&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">maskfile=NONE</span>
<span class="pre">pbkfile=NONE</span> <span class="pre">dafile=NONE</span></code> that are different from the way a normal Chandra
observation would be processed.</p>
</section>
<section id="creating-an-rmf-to-match-a-marx-simulation">
<h3>Creating an RMF to match a marx simulation<a class="headerlink" href="#creating-an-rmf-to-match-a-marx-simulation" title="Link to this heading">¶</a></h3>
<p><strong>marx</strong> maps energies to phas using the FEF gaussian parametrization utilized by
the <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkrmf.html">mkrmf</a> CIAO tool.  The newer <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkacisrmf.html">mkacisrmf</a> tool uses a more
complicated convolution model that does not appear to permit a fast,
memory-efficient random number generation algorithm that <strong>marx</strong> would
require.  In contrast, a gaussian-distributed random number generator
is all that is required to produce pha values that are consistent with
<a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkrmf.html">mkrmf</a> generated responses.</p>
<p>The Chandra CALDB includes several FEF files.  The one that
<strong>marx</strong> currently employs is
<code class="docutils literal notranslate"><span class="pre">acisD2000-01-29fef_phaN0005.fits</span></code>, and is located in
the <code class="docutils literal notranslate"><span class="pre">$CALDB/data/chandra/acis/cpf/fefs/</span></code> directory.  This file must
be specified as the <code class="docutils literal notranslate"><span class="pre">infile</span></code> <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkrmf.html">mkrmf</a> parameter.</p>
<p>For a point source simulation, look at the <a class="reference internal" href="../../Reference/tools.html#marx2fits"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marx2fits</span></code></a> generated event
file and find the average chip coordinates.  The CIAO <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/dmstat.html">dmstat</a> tool
may be used for this purpose.  The <code class="docutils literal notranslate"><span class="pre">CCD_ID</span></code> and the mean chip
coordinates are important for the creation of the filter that will be
passed to <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkrmf.html">mkrmf</a> to select the appropriate FEF tile.  For simplicity
suppose that the mean point source detector location is at (308,494)
on ACIS-7.  Then run <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkrmf.html">mkrmf</a> using (continuing the script from above):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="c1"># Mean chip position</span>
<span class="n">chipx</span><span class="o">=</span><span class="mi">221</span>
<span class="n">chipy</span><span class="o">=</span><span class="mi">532</span>

<span class="n">fef</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CALDB&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/data/chandra/acis/fef_pha/acisD2000-01-29fef_phaN0005.fits&quot;</span>

<span class="n">cxfilter</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;chipx_hi&gt;=</span><span class="si">{</span><span class="n">chipx</span><span class="si">}</span><span class="s2">,chipx_lo&lt;=</span><span class="si">{</span><span class="n">chipx</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">cyfilter</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;chipy_hi&gt;=</span><span class="si">{</span><span class="n">chipy</span><span class="si">}</span><span class="s2">,chipy_lo&lt;=</span><span class="si">{</span><span class="n">chipy</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">rt</span><span class="o">.</span><span class="n">mkrmf</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fef</span><span class="si">}</span><span class="s2">[ccd_id=</span><span class="si">{</span><span class="n">ccdid</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cxfilter</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">cyfilter</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">rmffile</span><span class="p">,</span>
         <span class="n">axis1</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;energy=</span><span class="si">{</span><span class="n">engrid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">axis2</span><span class="o">=</span><span class="n">phagrid</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Notice, how the FEF file is set explicitly to
<code class="docutils literal notranslate"><span class="pre">fef=&quot;$CALDB/data/chandra/acis/cpf/fefs/acisD2000-01-29fef_phaN0005.fits&quot;</span></code>
(where we use Python to retrieve the <code class="docutils literal notranslate"><span class="pre">$CALDB</span></code> environment variable)
and that the correct tile of that FEF file is chosen with
<code class="docutils literal notranslate"><span class="pre">fef[ccd_id=7,chipx_hi&gt;=221,chipx_lo&lt;=221,chipy_hi&gt;=532,chipy_lo&lt;=532]</span></code></p>
<p>See the <a class="reference external" href="http://cxc.harvard.edu/ciao/">CIAO</a> threads for other ways of running <a class="reference external" href="http://cxc.harvard.edu/ciao/ahelp/mkrmf.html">mkrmf</a>.  The important
thing is to specify the correct FEF and tile.</p>
</section>
</section>
<section id="analyzing-the-simulated-data">
<h2>Analyzing the simulated data<a class="headerlink" href="#analyzing-the-simulated-data" title="Link to this heading">¶</a></h2>
<p>The PHA, ARF, and RMF files may
be used in a spectral modelling program such as <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a> to see whether or
not one can reach the desired science goal from the simulated
observation.  For this example, the goal is to verify that the marx
simulation is consistent with the input spectrum.  To this end, <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a>
will be used to fit an absorbed powerlaw to the pha spectrum.  The
figure below showing the resulting fit was created via the following
script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sherpa.astro</span><span class="w"> </span><span class="kn">import</span> <span class="n">ui</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_pha</span><span class="p">(</span><span class="n">phafile</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_rmf</span><span class="p">(</span><span class="n">rmffile</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_arf</span><span class="p">(</span><span class="n">arffile</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">group_counts</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">set_source</span><span class="p">(</span><span class="n">ui</span><span class="o">.</span><span class="n">xsphabs</span><span class="o">.</span><span class="n">a</span> <span class="o">*</span> <span class="n">ui</span><span class="o">.</span><span class="n">xspowerlaw</span><span class="o">.</span><span class="n">p</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">nH</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">p</span><span class="o">.</span><span class="n">PhoIndex</span> <span class="o">=</span> <span class="mf">1.8</span>
<span class="n">p</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">ui</span><span class="o">.</span><span class="n">ignore</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">ignore</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
<p>This script produced the following parameter values with a an acceptable reduced
chi-square (“rstat”, the reduced value of the statistic, which in this case is a variant
of the chi-square statistic):</p>
<div class="code highlight-none notranslate"><div class="highlight"><pre><span></span>datasets       = (1,)
itermethodname = none
methodname     = levmar
statname       = chi2gehrels
succeeded      = True
parnames       = (&#39;a.nH&#39;, &#39;p.PhoIndex&#39;, &#39;p.norm&#39;)
parvals        = (1.008238467342707, 1.851566098580335, 0.0010115510749117442)
statval        = 277.39412826244575
istatval       = 11752995789.59782
dstatval       = 11752995512.203691
numpoints      = 348
dof            = 345
qval           = 0.9969121018746456
rstat          = 0.80404095148535
message        = successful termination
nfev           = 86
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">rplot_counts</span></code> may be used to produce a plot of the resulting
fit.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">ui</span><span class="o">.</span><span class="n">plot_fit_delchi</span><span class="p">(</span><span class="n">xlog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylog</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Simulated spectrum and fit without pile-up&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../../_downloads/33d2d5413a291532902104f2875cc7bd/powerlaw-12.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/a983521416079e0f37694c56e2f29ec1/powerlaw-12.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/8ff200b2902418c4c82581634fc0ca1a/powerlaw-12.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default">
<img alt="Plot of the spectrum" class="plot-directive" src="../../_images/powerlaw-12.png" />
</figure>
<p>The residuals show that the model is systematically high for some
energies.  The reason for this can be traced back to energy-dependent
scattering where photons are scattered outside the extraction region.
The CIAO effective area does not include this loss factor, and as a
result, this omission appears in the residuals.  This effect could be seen
better if we run the simulation 10 or 100 times longer.</p>
</section>
</section>
<section id="simulating-pile-up-in-an-acis-ccd-spectrum">
<h1>Simulating pile-up in an ACIS CCD spectrum<a class="headerlink" href="#simulating-pile-up-in-an-acis-ccd-spectrum" title="Link to this heading">¶</a></h1>
<p>The purpose of this example is to show how to use the <a class="reference internal" href="../../Reference/tools.html#marxpileup"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marxpileup</span></code></a>
program to simulate the effects of pileup.
<a class="reference internal" href="../../indetail/pileup.html#pileup"><span class="std std-ref">Pileup</span></a> occurs when two or more photons land in the same pixel location in a given
ACIS readout time.
<a class="reference internal" href="../../Reference/tools.html#marxpileup"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marxpileup</span></code></a> is a post-processor that
performs a frame-by-frame analysis of an existing <strong>marx</strong> simulation.
We continue the example from above, where the spectrum had a
somewhat large normalization to ensure that pileup would occur.</p>
<section id="creating-an-event-file-with-pile-up">
<h2>Creating an event file with pile-up<a class="headerlink" href="#creating-an-event-file-with-pile-up" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="../../Reference/tools.html#marxpileup"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marxpileup</span></code></a> can be run on the eventfile generated by <strong>marx</strong> using:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;marxpileup MarxOutputDir=plaw&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>This will create a directory called <code class="docutils literal notranslate"><span class="pre">plaw/pileup/</span></code> and place the
pileup results there.  It also writes a brief summary to the display
resembling:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Total Number Input: 770961
Total Number Detected: 482771
Efficiency: 6.261938e-01
</pre></div>
</div>
<p>This shows that because of pileup, nearly 40 percent of the events
were lost.</p>
<p>The next step is to run <a class="reference internal" href="../../Reference/tools.html#marx2fits"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marx2fits</span></code></a> to create a
corresponding level-2 file called <code class="docutils literal notranslate"><span class="pre">plaw_pileup_evt2.fits</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;marx2fits --pileup plaw/pileup plaw_pileup_evt2.fits&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Since this is a pileup simulation, the <code class="docutils literal notranslate"><span class="pre">--pileup</span></code> flag was passed
to <a class="reference internal" href="../../Reference/tools.html#marx2fits"><code class="xref std std-marxtool docutils literal notranslate"><span class="pre">marx2fits</span></code></a>.</p>
<p>In this case we can use the same ARF and RMF as above. However,
it is necessary to create a new PHA file from the
<code class="docutils literal notranslate"><span class="pre">plaw_pileup_evt2.fits</span></code> event file.  For analyzing a piled
observation of a near on-axis point source, it is recommended that the
extraction region have a radius of 4 ACIS tangent plane pixels.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Smaller radius this time</span>
<span class="n">R</span><span class="o">=</span><span class="mf">4.0</span>

<span class="n">evtfile</span><span class="o">=</span><span class="s2">&quot;plaw_pileup_evt2.fits&quot;</span>
<span class="n">phafile</span><span class="o">=</span><span class="s2">&quot;plaw_pileup_pha.fits&quot;</span>

<span class="n">rt</span><span class="o">.</span><span class="n">dmextract</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">evtfile</span><span class="si">}</span><span class="s2">[sky=Circle(</span><span class="si">{</span><span class="n">X</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">Y</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">R</span><span class="si">}</span><span class="s2">)][bin </span><span class="si">{</span><span class="n">phagrid</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
<span class="n">outfile</span><span class="o">=</span><span class="n">phafile</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="analyzing-the-pile-up-simulated-data">
<h2>Analyzing the pile-up simulated data<a class="headerlink" href="#analyzing-the-pile-up-simulated-data" title="Link to this heading">¶</a></h2>
<p>As before, <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a> will be used to analyze the piled spectrum.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ui</span><span class="o">.</span><span class="n">load_pha</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">,</span> <span class="s2">&quot;plaw_pileup_pha.fits&quot;</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_rmf</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">,</span> <span class="n">rmffile</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">load_arf</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">,</span> <span class="n">arffile</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">group_counts</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">set_source</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">,</span> <span class="n">ui</span><span class="o">.</span><span class="n">xsphabs</span><span class="o">.</span><span class="n">apileup</span> <span class="o">*</span> <span class="n">ui</span><span class="o">.</span><span class="n">xspowerlaw</span><span class="o">.</span><span class="n">pileup</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">nH</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">p</span><span class="o">.</span><span class="n">PhoIndex</span> <span class="o">=</span> <span class="mf">1.8</span>
<span class="n">p</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="mf">0.001</span>
<span class="n">ui</span><span class="o">.</span><span class="n">ignore</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">ignore</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The fit produces the following results:</p>
<div class="code highlight-none notranslate"><div class="highlight"><pre><span></span>datasets       = (&#39;pileup&#39;,)
itermethodname = none
methodname     = levmar
statname       = chi2gehrels
succeeded      = True
parnames       = (&#39;apileup.nH&#39;, &#39;pileup.PhoIndex&#39;, &#39;pileup.norm&#39;)
parvals        = (0.8585956409485702, 1.4831271103032238, 0.00039434742697988924)
statval        = 275.22533625885035
istatval       = 169454952634.7215
dstatval       = 169454952359.49615
numpoints      = 315
dof            = 312
qval           = 0.9341428013500872
rstat          = 0.8821324880091357
message        = successful termination
nfev           = 25
</pre></div>
</div>
<p>Note that the parameters are different
from the power-law parameters that went into the simulation.  For
example, the normalization is less than what was expected, and the
powerlaw index is somewhat low compared to the expected value of 1.8.</p>
<p>Suspecting that this observation suffers from pileup, we enable the
<a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a> pileup kernel, which introduces a few additional parameters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ui</span><span class="o">.</span><span class="n">set_pileup_model</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">,</span> <span class="n">ui</span><span class="o">.</span><span class="n">jdpileup</span><span class="o">.</span><span class="n">jdp</span><span class="p">)</span>
</pre></div>
</div>
<p>which gives us the following model:</p>
<div class="code highlight-none notranslate"><div class="highlight"><pre><span></span>xsphabs.a * xspowerlaw.p
   Param        Type          Value          Min          Max      Units
   -----        ----          -----          ---          ---      -----
   a.nH         thawed            1            0        1e+06 10^22 atoms / cm^2
   p.PhoIndex   thawed          1.8           -3           10
   p.norm       thawed        0.001            0        1e+24
</pre></div>
</div>
<p>Given the fact that the PSF fraction varies with
off-axis angle and spectral shape, we will allow it to vary during the
fit.</p>
<p>As before, the <a class="reference external" href="https://sherpa.readthedocs.io/en/latest/ui/api/sherpa.astro.ui.fit.html#sherpa.astro.ui.fit" title="(in Sherpa v4.18.0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">sherpa.astro.ui.fit()</span></code></a> command may be used to compute the best
fit parameters.  However, the parameter space in the context of the
pileup kernel can be complex with many local minima, even for a
function as simple as an absorbed powerlaw.  For this reason it
might be useful to start the fit multiple times from different
starting points or use an optimizer such as a Monte-Carlo algorithm
to explore the parameter space more fully, but here we begin with the
fastest method, using the default optimizer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ui</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The above produces:</p>
<blockquote>
<div></div></blockquote>
<div class="code highlight-none notranslate"><div class="highlight"><pre><span></span>datasets       = (&#39;pileup&#39;,)
itermethodname = none
methodname     = levmar
statname       = chi2gehrels
succeeded      = True
parnames       = (&#39;jdp.alpha&#39;, &#39;jdp.f&#39;, &#39;apileup.nH&#39;, &#39;pileup.PhoIndex&#39;, &#39;pileup.norm&#39;)
parvals        = (0.33365112932727603, 0.9073770263942982, 1.0471344833861749, 1.9162174662548832, 0.0011267173327421196)
statval        = 208.6955072371393
istatval       = 1157.9658971633373
dstatval       = 949.270389926198
numpoints      = 315
dof            = 310
qval           = 0.9999978282647793
rstat          = 0.6732113136681913
message        = successful termination
nfev           = 267
</pre></div>
</div>
<p>We see that the reduced chi-square is near what one would expect for a
good fit and that the powerlaw index is very close to the expected
value.  We can use the <a class="reference external" href="https://sherpa.readthedocs.io/en/latest/ui/api/sherpa.astro.ui.conf.html#sherpa.astro.ui.conf" title="(in Sherpa v4.18.0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">sherpa.astro.ui.conf()</span></code></a> function to obtain its confidence
interval if we want to.</p>
<p>Here is a plot of the resulting fit. We use the <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a> plotting function
<a class="reference external" href="https://sherpa.readthedocs.io/en/latest/ui/api/sherpa.astro.ui.plot_data.html#sherpa.astro.ui.plot_data" title="(in Sherpa v4.18.0)"><code class="xref py py-func docutils literal notranslate"><span class="pre">sherpa.astro.ui.plot_data()</span></code></a> and pass several options to customize the plot. Options that
are not processed by <a class="reference external" href="http://cxc.harvard.edu/sherpa/">Sherpa</a> itself are passed to <a class="reference external" href="https://matplotlib.org/">matplotlib</a> (e.g.
<code class="docutils literal notranslate"><span class="pre">color='C0'</span></code> sets the first color in the default color cycle in <a class="reference external" href="https://matplotlib.org/">matplotlib</a>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ui</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">yerrorbars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">xlog</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ylog</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">,</span> <span class="n">yerrorbars</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">plot_model</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="n">overplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;data and model without pileup&#39;</span><span class="p">)</span>
<span class="n">ui</span><span class="o">.</span><span class="n">plot_model</span><span class="p">(</span><span class="s2">&quot;pileup&quot;</span><span class="p">,</span> <span class="n">overplot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;data and model with pileup&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;The effect of pile-up on the spectrum&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../../_downloads/3042fd7504f2d32e2c67d0b3a51995ef/powerlaw-22.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/f1cf10e4cc2c89c8dd78f52cf1c482a9/powerlaw-22.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>, <a class="reference download internal" download="" href="../../_downloads/c6ddcb5efe245ad18941805f17971e99/powerlaw-22.pdf"><code class="xref download docutils literal notranslate"><span class="pre">pdf</span></code></a>)</p>
<figure class="align-default" id="id1">
<img alt="Plot of the pile-up spectrum. Model and data fit well now." class="plot-directive" src="../../_images/powerlaw-22.png" />
<figcaption>
<p><span class="caption-text">Plot of the original and the piled-up spectrum</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Comparing the spectrum simulated without pile-up and with pile-up
shows how pile-up distorts the spectral shape.  Pile-up reduces the
number of counts overall because some events are combined with other events
such that they look like a cosmic ray or some other background noise that is
removed by Chandra’s grade filtering.
Pile-up also hardens the spectrum because multiple low-energy photons
are detected as single higher-energy events.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<form action="../../search.html" method="get">
<input type="text" name="q" placeholder="Search" />
<input type="hidden" name="check_keywords" value="yes" />
<input type="hidden" name="area" value="default" />
</form>
  <h3><a href="../../index.html">Page Content</a></h3>
  <ul>
<li><a class="reference internal" href="#">Simulating a user-defined CCD spectrum with ACIS</a><ul>
<li><a class="reference internal" href="#creating-the-spectral-file">Creating the spectral file</a></li>
<li><a class="reference internal" href="#running-marx-for-this-powerlaw-spectrum">Running marx for this powerlaw spectrum</a></li>
<li><a class="reference internal" href="#creating-ciao-based-arfs-and-rmfs-for-marx-simulations">Creating CIAO-based ARFs and RMFs for MARX Simulations</a><ul>
<li><a class="reference internal" href="#creating-an-arf-to-match-a-marx-simulation">Creating an ARF to match a marx simulation</a></li>
<li><a class="reference internal" href="#creating-an-rmf-to-match-a-marx-simulation">Creating an RMF to match a marx simulation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#analyzing-the-simulated-data">Analyzing the simulated data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simulating-pile-up-in-an-acis-ccd-spectrum">Simulating pile-up in an ACIS CCD spectrum</a><ul>
<li><a class="reference internal" href="#creating-an-event-file-with-pile-up">Creating an event file with pile-up</a></li>
<li><a class="reference internal" href="#analyzing-the-pile-up-simulated-data">Analyzing the pile-up simulated data</a></li>
</ul>
</li>
</ul>

  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="../examples.html"
                          title="previous chapter">Examples of MARX in use</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="../aped/aped.html"
                          title="next chapter">Simulating a thermal plasma with the HETGS grating</a></p>
  </div><hr style="color: #FFF;"></hr>
<a href="http://cxc.harvard.edu/">
    <img src="../../_static/cxcfooterCXCicon.png" 
	 alt="Chandra X-ray Center" class="img-logo"></img>
</a>
<p></p>
<a href="http://space.mit.edu/cxc/">CXC@MIT</a>
<p></p>
<a href="http://space.mit.edu/">
    <img src="../../_static/logo-mit-kavli.png" 
	 alt="MIT Kavli Institute" class="img-logo"></img>
</a>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../std-parindex.html" title="MARX Parameter Index"
             >MARX Parameters</a> |</li>
        <li class="right" >
          <a href="../aped/aped.html" title="Simulating a thermal plasma with the HETGS grating"
             >next</a> |</li>
        <li class="right" >
          <a href="../examples.html" title="Examples of MARX in use"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">MARX 6.0.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../examples.html" >Examples of MARX in use</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Simulating a user-defined CCD spectrum with ACIS</a></li> 
      </ul>
    </div>
    <div class="footer">
    <a href="mailto:marx-help@space.mit.edu">MARX support: marx-help@space.mit.edu</a>
    <a href="https://accessibility.mit.edu/">Accessibility</a>
        &copy; Copyright 2002-2025, Massachusetts Institute of Technology.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>